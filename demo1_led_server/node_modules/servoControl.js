var gpio = require('pi-gpio');

var servoControllerPin = 7;

exports.blinkInterval = function(req, res){
	blink(servoControllerPin, req.params.interval);
	res.json(200, {message: 'success'});
}

exports.blink = function(req, res){
	blink(servoControllerPin);
	res.json(200, {message: 'success'});

}

exports.turnLeft = function(req, res){
	console.log('turning left');
	res.json(200, {message: 'success'});
}

exports.turnRight = function(req, res){
	console.log('turning right');
	res.json(200, {message: 'success'});
}

exports.turnOnLED = function(req, res){
	console.log('turning On')
	turnOn(servoControllerPin)
	res.json(200, {message: 'success'});
}

exports.turnOffLED = function(req, res){
	console.log('turning Off')
	turnOff(servoControllerPin)	
//	closePin(servoControllerPin)
	res.json(200, {message: 'success'});
}

function writeLEDHigh11(pin) {
    gpio.write(pin, true, function(err) {
        console.log('Written to pin');
    });
}

function writeLEDHigh(pin){
	console.log(pin + " high");
	writeHigh(pin);
	console.log("success");
}

function writeLEDHigh_bad22(pin) {
	setInterval(function(){
		writeHigh(pin);
		}, 0);
}

function writeLEDHigh_bad(pin){
	gpio.writeSync(1);
}

function blink_1f(pin, interval){
        if(interval == undefined) interval = 0;
      // function onloop(){ 
	setInterval(function() {
                        writeHigh(pin);
                }, -1);
//	}
      //  onloop();
}

function blink_2f(pin, interval){
	if(interval == undefined) interval = 0;
//	function onloop(){
	//	setTimeout(function(){
			//alternating between off and on
			writeHigh(pin);
	//	}, -1);
//	}
	//onloop();
}

function blink(pin, interval, blinkTime){
	//set default value of interval
	if(interval == undefined) interval = 500;
	//set default time for blinkTime
	if(blinkTime == undefined) blinkTime = 5;

	//initialize the counting variable
	var i = 1;

	//timed loop to turn on and off the loop
	function blinkloop(){
		setTimeout(function(){
			//alternating between off and on
			if(i%2 == 0){
				console.log("**** blink " + i/2 + " time")
				writeHigh(pin);
			} else {
				writeLow(pin);
			}
			i++;
			if(i <= blinkTime*2){
				blinkloop();
			} else {
				closePin(pin)
			}
		}, interval);
	}
	//first call of the loop
	blinkloop();
}

function writeHigh(pin){
	console.log(pin + " high");
	gpio.open(pin, "output", function(err) {
	    gpio.write(pin, 1, function() {
		gpio.close(pin);
	    });
	});
}

function writeLow(pin){
	console.log(pin + " low");
	gpio.open(pin, "output", function(err) {
	    gpio.write(pin, 0, function() {
	        gpio.close(pin);
	    });
	});
}

function turnOff(pin){
        console.log(pin + " low");
        gpio.open(pin, "output", function(err) {
            gpio.write(pin, 0, function() {
		gpio.close(pin);
            });
        });
}

function turnOn(pin){
	console.log(pin + " high");
	gpio.open(pin, "output", function(err) {
	    gpio.write(pin, 1, function() {
//	        gpio.close(pin);
	    });
	});
}

function initPin(pin){
            gpio.open(pin, "output", function(err) {
            gpio.write(pin, 0, function() {
                gpio.close(pin);
            });
        });
}

function closePin(pin){
	console.log('Turning pin off since we are done.');
	console.log(pin + " -");
		gpio.open(pin, "output", function(err) {
	    gpio.write(pin, 0, function() { 
	        //gpio.close(pin);
	    });
	});
}
